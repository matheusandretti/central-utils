<!-- public/nfe.html -->
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <title>Monitor de NF-e - Rob√¥</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>

<body class="app-body nfe-body">
  <div class="nfe-layout">
    <!-- SIDEBAR -->
    <aside class="nfe-sidebar">
      <div class="nfe-sidebar-top">
        <div class="nfe-sidebar-logo">
          <span class="logo-circle">WL</span>
          <span class="logo-text">Portal</span>
        </div>

        <button class="nfe-sidebar-toggle" id="sidebarToggle" type="button">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>

      <nav class="nfe-sidebar-menu">
        <a href="/home.html" class="nfe-menu-item">
          <span class="icon">üè†</span>
          <span class="label">In√≠cio</span>
        </a>
        <a href="/home.html#fiscal" class="nfe-menu-item">
          <span class="icon">üìÅ</span>
          <span class="label">Fiscal</span>
        </a>
        <a href="/nfe" class="nfe-menu-item active">
          <span class="icon">üßæ</span>
          <span class="label">Consulta NF-e</span>
        </a>
      </nav>
    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="nfe-main">
      <!-- Cabe√ßalho / Breadcrumb -->
      <header class="nfe-header">
        <div class="nfe-breadcrumb">Portal / Fiscal / Consulta NF-e</div>
        <h1>Monitor de NF-e</h1>
        <p>Automatize a consulta de notas no Portal Nacional usando o NFe Helper.</p>
      </header>

      <!-- Linha com Upload + Extens√£o -->
      <section class="nfe-row">
        <!-- CARD UPLOAD -->
        <div class="nfe-card nfe-card-upload">
          <h2>Upload de arquivo com chaves</h2>
          <p class="nfe-card-subtitle">
            Envie um arquivo de texto, planilha ou lista com as chaves de acesso que deseja consultar.
          </p>

          <form id="uploadForm" class="nfe-upload-form">
            <label for="fileInput" class="nfe-input-file-label">
              <span>Selecionar arquivo...</span>
              <input type="file" name="file" id="fileInput" required />
            </label>

            <button type="submit" id="btnUpload" class="btn btn-primary">
              Enviar arquivo
            </button>
          </form>

          <div id="uploadMessage" class="nfe-upload-message"></div>
        </div>

        <!-- CARD EXTENS√ÉO / PORTAL -->
        <div class="nfe-card nfe-card-ext">
          <h2>Extens√£o &amp; Portal Nacional NF-e</h2>
          <p class="nfe-card-subtitle">
            Para usar o rob√¥, instale e mantenha ativa a extens√£o <strong>Consulta NFe Helper</strong>.
          </p>

          <button id="btnOpenPortal" class="btn btn-secondary" disabled>
            Iniciar consultas no Portal NF-e
          </button>

          <div id="extStatus" class="nfe-ext-status"></div>
        </div>
      </section>

      <!-- Resumo da fila -->
      <section class="nfe-card nfe-card-dashboard">
        <div class="nfe-card-header">
          <h2>Resumo da fila</h2>
        </div>

        <div class="nfe-metrics">
          <div class="nfe-metric nfe-metric-pending">
            <span class="label">Pendentes</span>
            <strong id="cardPending">0</strong>
          </div>
          <div class="nfe-metric nfe-metric-processing">
            <span class="label">Processando</span>
            <strong id="cardProcessing">0</strong>
          </div>
          <div class="nfe-metric nfe-metric-captcha">
            <span class="label">Aguardando Captcha</span>
            <strong id="cardWaitingCaptcha">0</strong>
          </div>
          <div class="nfe-metric nfe-metric-done">
            <span class="label">Conclu√≠dos</span>
            <strong id="cardDone">0</strong>
          </div>
          <div class="nfe-metric nfe-metric-error">
            <span class="label">Erros</span>
            <strong id="cardError">0</strong>
          </div>
        </div>
      </section>

      <!-- Tabela da fila -->
      <section class="nfe-card nfe-card-table">
        <div class="nfe-card-header nfe-card-header-with-actions">
          <div>
            <h2>Fila de chaves</h2>
            <p class="nfe-card-subtitle">
              Acompanhe o status de cada chave enviada para consulta.
            </p>
          </div>
          <div class="nfe-table-actions">
            <button id="btnClearPending" class="btn btn-ghost-danger">
              Limpar pendentes
            </button>
            <button id="btnClearDone" class="btn btn-ghost-danger">
              Limpar conclu√≠dos
            </button>
            <button id="btnClearErrors" class="btn btn-ghost-danger">
              Limpar erros
            </button>
          </div>
        </div>

        <div class="nfe-table-wrapper">
          <table class="nfe-table">
            <thead>
              <tr>
                <th>Chave</th>
                <th>Status</th>
                <th>Mensagem</th>
                <th>Atualizado em</th>
              </tr>
            </thead>
            <tbody id="jobsTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Aviso de captcha -->
      <section class="nfe-card nfe-card-warning" id="captchaNotification" style="display:none;">
        <div class="nfe-warning-icon">‚ö†Ô∏è</div>
        <div>
          <strong>Aten√ß√£o:</strong> existe(m) chave(s) aguardando valida√ß√£o de captcha.
          <p>Verifique a janela do Portal Nacional e conclua a valida√ß√£o.</p>
        </div>
      </section>
    </main>
  </div>

  <script>
    const socket = io();

    const jobsTableBody = document.getElementById('jobsTableBody');
    const uploadForm = document.getElementById('uploadForm');
    const uploadMessage = document.getElementById('uploadMessage');
    const captchaNotification = document.getElementById('captchaNotification');

    const btnUpload = document.getElementById('btnUpload');

    const cards = {
      pending: document.getElementById('cardPending'),
      processing: document.getElementById('cardProcessing'),
      waiting_captcha: document.getElementById('cardWaitingCaptcha'),
      done: document.getElementById('cardDone'),
      error: document.getElementById('cardError'),
    };

    // Bot√£o / status da extens√£o e URL do portal
    const btnOpenPortal = document.getElementById('btnOpenPortal');
    const extStatus = document.getElementById('extStatus');
    const PORTAL_CONSULTA_URL =
      'https://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=resumo&tipoConteudo=7PhJ+gAVw2g=';

    // Controle de extens√£o / fila
    let lastSummary = null;
    let extensionStatusKnown = false;
    let extensionAvailable = false;

    // ---- Controles de limpar filas ----
    const btnClearPending = document.getElementById('btnClearPending');
    const btnClearDone = document.getElementById('btnClearDone');
    const btnClearErrors = document.getElementById('btnClearErrors');

    // ----------- FUN√á√ÉO DE LOADING DO UPLOAD -----------

    function setUploadLoading(isLoading) {
      if (!btnUpload) return;
      if (isLoading) {
        btnUpload.disabled = true;
        btnUpload.textContent = 'Enviando...';
      } else {
        btnUpload.disabled = false;
        btnUpload.textContent = 'Enviar arquivo';
      }
    }

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      uploadMessage.textContent = 'Enviando...';
      setUploadLoading(true);

      const formData = new FormData(uploadForm);

      try {
        const resp = await fetch('/upload', {
          method: 'POST',
          body: formData,
        });
        const data = await resp.json();
        if (resp.ok) {
          uploadMessage.textContent = data.message || 'Upload conclu√≠do.';
        } else {
          uploadMessage.textContent = data.error || 'Erro no upload.';
        }
      } catch (err) {
        uploadMessage.textContent = 'Erro de comunica√ß√£o com o servidor.';
      } finally {
        setUploadLoading(false);
      }
    });

    // Clique no bot√£o para abrir o portal em nova aba
    btnOpenPortal.addEventListener('click', () => {
      window.open(PORTAL_CONSULTA_URL, '_blank');
    });

    function renderSummary(summary) {
      cards.pending.textContent = summary.pending;
      cards.processing.textContent = summary.processing;
      cards.waiting_captcha.textContent = summary.waiting_captcha;
      cards.done.textContent = summary.done;
      cards.error.textContent = summary.error;

      // mostra aviso de captcha se tiver pelo menos um
      captchaNotification.style.display =
        summary.waiting_captcha > 0 ? 'block' : 'none';
    }

    function renderJobs(jobs) {
      jobsTableBody.innerHTML = '';
      jobs
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .forEach((job) => {
          const tr = document.createElement('tr');

          const statusLabel = {
            pending: 'Pendente',
            processing: 'Processando',
            waiting_captcha: 'Aguardando Captcha',
            done: 'Conclu√≠do',
            error: 'Erro',
          }[job.status] || job.status;

          tr.innerHTML = `
            <td>${job.key}</td>
            <td>${statusLabel}</td>
            <td>${job.errorMessage || ''}</td>
            <td>${new Date(job.updatedAt).toLocaleString('pt-BR')}</td>
          `;
          jobsTableBody.appendChild(tr);
        });
    }

    // Gera o HTML com instru√ß√µes de instala√ß√£o quando a extens√£o N√ÉO √© encontrada
    function gerarHtmlInstrucoesExtensao() {
      return `
        Extens√£o NFe Helper <strong>n√£o encontrada</strong> neste navegador.<br><br>

        <strong>1) Baixar extens√£o (uso interno):</strong><br>
        - <a href="/extensao-nfe-helper.zip" download>Baixar arquivo extensao-nfe-helper.zip</a><br>
        - Descompacte o .zip em uma pasta qualquer (ex.: Documentos\\NFeHelper).<br><br>

        <strong>2) Instalar no Chrome (Windows):</strong><br>
        1. Abra <code>chrome://extensions</code> na barra de endere√ßos.<br>
        2. Ative a op√ß√£o <em>"Modo do desenvolvedor"</em> (canto superior direito).<br>
        3. Clique em <em>"Carregar sem compacta√ß√£o"</em>.<br>
        4. Selecione a pasta onde voc√™ descompactou a extens√£o.<br><br>

        <strong>3) Instalar no Firefox (uso manual):</strong><br>
        1. Abra <code>about:debugging</code> na barra de endere√ßos.<br>
        2. Clique em <em>"Este Firefox"</em>.<br>
        3. Clique em <em>"Carregar add-on tempor√°rio"</em>.<br>
        4. Escolha o arquivo <code>manifest.json</code> dentro da pasta da extens√£o.<br>
        (para uso permanente, o ideal √© configurar uma distribui√ß√£o interna ou assinar o add-on).<br><br>

        Ap√≥s instalar, recarregue esta p√°gina (F5) para que o painel reconhe√ßa a extens√£o.
      `;
    }

    function atualizarEstadoExtensaoESbotao(summary) {
      lastSummary = summary;

      const haPendentes = summary.pending > 0;

      if (!haPendentes) {
        // sem chaves pendentes, n√£o faz sentido abrir portal
        btnOpenPortal.disabled = true;
        extStatus.textContent = "Nenhuma chave pendente na fila.";
        return;
      }

      // j√° sabemos o status da extens√£o? s√≥ atualiza bot√£o
      if (extensionStatusKnown) {
        btnOpenPortal.disabled = !extensionAvailable;
        return;
      }

      // primeira vez com pendentes: vamos checar a extens√£o
      extStatus.textContent = "Verificando extens√£o NFe Helper...";
      btnOpenPortal.disabled = true;

      detectarExtensaoNFeHelper().then((ok) => {
        extensionStatusKnown = true;
        extensionAvailable = ok;

        if (ok) {
          extStatus.textContent =
            'Extens√£o NFe Helper detectada. Clique em "Iniciar consultas no Portal NF-e".';
          btnOpenPortal.disabled = false;
        } else {
          extStatus.innerHTML = gerarHtmlInstrucoesExtensao();
          btnOpenPortal.disabled = true;
        }
      });
    }

    socket.on('queue_update', ({ summary, jobs }) => {
      renderSummary(summary);
      renderJobs(jobs);
      atualizarEstadoExtensaoESbotao(summary);
    });

    // Toggle do sidebar (recolher/expandir)
    document.addEventListener('DOMContentLoaded', () => {
      const layout = document.querySelector('.nfe-layout');
      const sidebarToggle = document.getElementById('sidebarToggle');

      if (layout && sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
          layout.classList.toggle('collapsed');
        });
      }
    });

    socket.on('job_update', (job) => {
      // opcional, se quiser tratar job a job
    });

    // Fun√ß√£o de detec√ß√£o da extens√£o (PING/PONG)
    function detectarExtensaoNFeHelper(timeoutMs = 800) {
      return new Promise((resolve) => {
        let respondeu = false;

        function handler(event) {
          if (event.source !== window) return;
          if (!event.data || event.data.type !== "NFE_HELPER_PONG") return;
          respondeu = true;
          window.removeEventListener("message", handler);
          resolve(true);
        }

        window.addEventListener("message", handler);

        // envia o PING
        window.postMessage({ type: "NFE_HELPER_PING" }, "*");

        // se ningu√©m responder, consideramos que a extens√£o n√£o est√° instalada
        setTimeout(() => {
          if (!respondeu) {
            window.removeEventListener("message", handler);
            resolve(false);
          }
        }, timeoutMs);
      });
    }

    // ---- Bot√£o "Limpar pendentes" (j√° existia, s√≥ mantive) ----
    btnClearPending.addEventListener('click', async () => {
      if (!confirm("Tem certeza que deseja REMOVER TODAS as chaves pendentes/processando da fila?")) {
        return;
      }

      try {
        const resp = await fetch('/api/clear-pending', { method: 'POST' });
        const data = await resp.json();

        if (data.ok) {
          alert("Chaves pendentes/processando removidas da fila.");
        } else {
          alert("Erro: " + (data.error || "Falha desconhecida"));
        }
      } catch (err) {
        alert("Erro ao comunicar com o servidor.");
      }
    });

    // ---- Bot√£o "Limpar conclu√≠dos" ----
    btnClearDone.addEventListener('click', async () => {
      if (!confirm("Tem certeza que deseja remover TODOS os registros conclu√≠dos da fila?")) {
        return;
      }

      try {
        const resp = await fetch('/api/clear-done', { method: 'POST' });
        const data = await resp.json();

        if (data.ok) {
          alert("Registros conclu√≠dos removidos da fila.");
        } else {
          alert("Erro: " + (data.error || "Falha desconhecida"));
        }
      } catch (err) {
        alert("Erro ao comunicar com o servidor.");
      }
    });

    // ---- Bot√£o "Limpar erros" ----
    btnClearErrors.addEventListener('click', async () => {
      if (!confirm("Tem certeza que deseja remover TODOS os registros com erro da fila?")) {
        return;
      }

      try {
        const resp = await fetch('/api/clear-errors', { method: 'POST' });
        const data = await resp.json();

        if (data.ok) {
          alert("Registros com erro removidos da fila.");
        } else {
          alert("Erro: " + (data.error || "Falha desconhecida"));
        }
      } catch (err) {
        alert("Erro ao comunicar com o servidor.");
      }
    });

  </script>
</body>

</html>